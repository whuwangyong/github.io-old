<!DOCTYPE html>
<html lang="">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <title>kafka consumer seek之后立即poll可能拉不到消息 - 武大路飞</title><meta name="author" content="Wang Yong">
<meta name="author-link" content="https://github.com/whuwangyong">
<meta name="description" content="问题 有个需求，需要频繁seek到指定partition的指定offset，然后poll，且只poll一次，目的是为了快速将指定offset的消息拉取出来。 通常的poll写法是，将poll逻辑放在死循环里，第一次拉不到，第二次继续。如果off" />
<meta name="keywords" content="kafka,kafka consumer" /><meta itemprop="name" content="kafka consumer seek之后立即poll可能拉不到消息">
<meta itemprop="description" content="问题 有个需求，需要频繁seek到指定partition的指定offset，然后poll，且只poll一次，目的是为了快速将指定offset的消息拉取出来。 通常的poll写法是，将poll逻辑放在死循环里，第一次拉不到，第二次继续。如果off"><meta itemprop="datePublished" content="2022-05-31T00:00:00+08:00" />
<meta itemprop="dateModified" content="2022-06-03T10:34:27+08:00" />
<meta itemprop="wordCount" content="2546"><meta itemprop="image" content="https://whuwangyong.github.io/avatar150x150.jpg"/>
<meta itemprop="keywords" content="kafka,kafka consumer," /><meta property="og:title" content="kafka consumer seek之后立即poll可能拉不到消息" />
<meta property="og:description" content="问题 有个需求，需要频繁seek到指定partition的指定offset，然后poll，且只poll一次，目的是为了快速将指定offset的消息拉取出来。 通常的poll写法是，将poll逻辑放在死循环里，第一次拉不到，第二次继续。如果off" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://whuwangyong.github.io/2022-02-17-kafka-seek-poll/" /><meta property="og:image" content="https://whuwangyong.github.io/avatar150x150.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-31T00:00:00+08:00" />
<meta property="article:modified_time" content="2022-06-03T10:34:27+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://whuwangyong.github.io/avatar150x150.jpg"/>

<meta name="twitter:title" content="kafka consumer seek之后立即poll可能拉不到消息"/>
<meta name="twitter:description" content="问题 有个需求，需要频繁seek到指定partition的指定offset，然后poll，且只poll一次，目的是为了快速将指定offset的消息拉取出来。 通常的poll写法是，将poll逻辑放在死循环里，第一次拉不到，第二次继续。如果off"/>
<meta name="application-name" content="武大路飞">
<meta name="apple-mobile-web-app-title" content="武大路飞"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#252627"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="https://whuwangyong.github.io/2022-02-17-kafka-seek-poll/" /><link rel="prev" href="https://whuwangyong.github.io/2022-05-30-kafka-tx/" /><link rel="next" href="https://whuwangyong.github.io/2022-07-23-use-process-explorer-to-detect-ad-process/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "kafka consumer seek之后立即poll可能拉不到消息",
    "inLanguage": "",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/whuwangyong.github.io\/2022-02-17-kafka-seek-poll\/"
    },"image": ["https:\/\/whuwangyong.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "kafka, kafka consumer","wordcount":  2546 ,
    "url": "https:\/\/whuwangyong.github.io\/2022-02-17-kafka-seek-poll\/","datePublished": "2022-05-31T00:00:00+08:00","dateModified": "2022-06-03T10:34:27+08:00","publisher": {
      "@type": "Organization",
      "name": "Wang Yong","logo": {
          "@type": "ImageObject",
          "url": "https:\/\/whuwangyong.github.io\/images\/avatar150x150.jpg",
          "width":  150 ,
          "height":  151 
        }},"author": {
        "@type": "Person",
        "name": "Wang Yong"
      },"description": ""
  }
  </script></head>
  <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script><div class="wrapper"><header class="desktop" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="武大路飞"><span class="header-title-pre"><i class='fa fa-home'></i></span><span class="header-title-text">武大路飞的博客</span></a></div>
    <nav>
      <ul class="menu"><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="/posts/"
                
                
              >归档</a></li><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="/links/"
                title="友情链接"
                
              >友链</a></li><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="https://github.com/whuwangyong"
                title="GitHub"
                rel="noopener noreffer" target="_blank"
              ><i class='fab fa-github fa-fw'></i> GitHub</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="武大路飞"><span class="header-title-pre"><i class='fa fa-home'></i></span><span class="header-title-text">武大路飞的博客</span></a></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="/posts/"
                
                
              >归档</a></li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="/links/"
                title="友情链接"
                
              >友链</a></li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="https://github.com/whuwangyong"
                title="GitHub"
                rel="noopener noreffer" target="_blank"
              ><i class='fab fa-github fa-fw'></i> GitHub</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw"></i>
        </li></ul>
    </nav>
  </div>
</header>
<div class="search-dropdown desktop">
  <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
  <div id="search-dropdown-mobile"></div>
</div>
<main class="container" page-style="custom"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    
  </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">kafka consumer seek之后立即poll可能拉不到消息</h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a
  href="https://github.com/whuwangyong"
  
    title="作者"
  
  
    
    
    target="_blank"
  
  
    rel="external nofollow noopener noreffer author"
  
  
    class="author"
  
  
><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/images/avatar150x150.jpg"
    data-srcset="/images/avatar150x150.jpg, /images/avatar150x150.jpg 1.5x, /images/avatar150x150.jpg 2x"
    data-sizes="auto"
    alt="Wang Yong"
    title="Wang Yong" />&nbsp;Wang Yong</a></span>
          <span class="post-category">收录于 <a href="/categories/kafka/"><i class="fa-regular fa-folder fa-fw"></i>&nbsp;kafka</a></span></div>
      <div class="post-meta-line"><span title=2022-05-31&#32;00:00:00>
            <i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-05-31" >2022-05-31</time>
          </span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 2546 字&nbsp;
        <i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 6 分钟&nbsp;</div>
    </div><div class="details toc" id="toc-static" kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#问题">问题</a></li>
    <li><a href="#分析">分析</a>
      <ul>
        <li><a href="#猜测1-新旧poll方法的区别">猜测1 新旧poll方法的区别</a></li>
        <li><a href="#猜测2-timeout决定了一切">猜测2 timeout决定了一切</a></li>
        <li><a href="#真相-consumerendoffsets">真相？ consumer.endOffsets()</a></li>
      </ul>
    </li>
    <li><a href="#结论">结论</a></li>
    <li><a href="#测试代码">测试代码</a></li>
  </ul>
</nav></div>
      </div><div
      class="content"
      id="content"
      
      
    ><h2 id="问题">问题</h2>
<p>有个需求，需要频繁seek到指定partition的指定offset，然后poll，且只poll一次，目的是为了<strong>快速</strong>将指定offset的消息拉取出来。</p>
<p>通常的poll写法是，将poll逻辑放在死循环里，第一次拉不到，第二次继续。如果offset上有消息，就一定能消费到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">consumer</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="s">&#34;topics&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">records</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do something with records
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但我使用的是consumer.assign()方法，而不是subscribe()。因为要灵活指定分区，用subscribe的话，触发rebalance很麻烦。代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">seekAndPoll</span><span class="o">(</span><span class="n">String</span> <span class="n">topic</span><span class="o">,</span> <span class="kt">int</span> <span class="n">partition</span><span class="o">,</span> <span class="kt">long</span> <span class="n">offset</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TopicPartition</span> <span class="n">tp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopicPartition</span><span class="o">(</span><span class="n">topic</span><span class="o">,</span> <span class="n">partition</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">consumer</span><span class="o">.</span><span class="na">assign</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">tp</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;assignment:&#34;</span> <span class="o">+</span> <span class="n">consumer</span><span class="o">.</span><span class="na">assignment</span><span class="o">());</span> <span class="c1">// 这里是有分配到分区的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">consumer</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">tp</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="n">100</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="o">(</span><span class="n">records</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 大概率拉取不到消息，进入此分支
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">records</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于我只poll一次，这就要求必须一次拉到消息。从现象上看，感觉是在seek之后，kafka有些metadata更新之类的操作未执行完毕，此时poll就拉不到消息。</p>
<p>我在StackOverflow上也搜到了这个问题（<a
  href="https://stackoverflow.com/questions/68802558/kafka-cluster-sometimes-returns-no-records-during-seek-and-poll"
  
  
    
    
    target="_blank"
  
  
    rel="external nofollow noopener noreffer"
  
  
  
>java - Kafka Cluster sometimes returns no records during seek and poll - Stack Overflow</a>），但是没有答案。在解决了这个问题后，我添加了一个答案。</p>
<h2 id="分析">分析</h2>
<h3 id="猜测1-新旧poll方法的区别">猜测1 新旧poll方法的区别</h3>
<p>在测试时，发现有时使用旧版本的<code>poll(long timeout)</code>方法有效，使用新版本的<code>poll(Duration timeout)</code>方法无效。会不会跟这个有关？（调式发现无关，不感兴趣的可跳过这一节）</p>
<p>两个poll方法签名如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="nf">poll</span><span class="o">(</span><span class="kd">final</span> <span class="kt">long</span> <span class="n">timeoutMs</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">poll</span><span class="o">(</span><span class="n">time</span><span class="o">.</span><span class="na">timer</span><span class="o">(</span><span class="n">timeoutMs</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="nf">poll</span><span class="o">(</span><span class="kd">final</span> <span class="n">Duration</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">poll</span><span class="o">(</span><span class="n">time</span><span class="o">.</span><span class="na">timer</span><span class="o">(</span><span class="n">timeout</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>二者都调用了下面的这个poll方法，关键在于第二个参数<code>includeMetadataInTimeout</code>，新版为false，老版为true。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="nf">poll</span><span class="o">(</span><span class="kd">final</span> <span class="n">Timer</span> <span class="n">timer</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">includeMetadataInTimeout</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">includeMetadataInTimeout</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// try to update assignment metadata BUT do not need to block on the timer for join group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">updateAssignmentMetadataIfNeeded</span><span class="o">(</span><span class="n">timer</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(!</span><span class="n">updateAssignmentMetadataIfNeeded</span><span class="o">(</span><span class="n">time</span><span class="o">.</span><span class="na">timer</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">),</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Still waiting for metadata&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个Boolean值最终传递给了<code>coordinator.poll()</code>的<code>waitForJoinGroup</code>。因此，关键就在于<code>coordinator</code>在poll的时候是否等待消费者成功加入消费组。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">updateAssignmentMetadataIfNeeded</span><span class="o">(</span><span class="kd">final</span> <span class="n">Timer</span> <span class="n">timer</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">waitForJoinGroup</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">coordinator</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">coordinator</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">timer</span><span class="o">,</span> <span class="n">waitForJoinGroup</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">updateFetchPositions</span><span class="o">(</span><span class="n">timer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但调试发现，在使用assign手动指定消费分区时，coordinator 为 null。这很好理解，只有subscribe模式才存在重平衡等情况，需要coordinator进行协调。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="assets/image-20220531165520-92q6hbk.png"
    data-srcset="/2022-02-17-kafka-seek-poll/assets/image-20220531165520-92q6hbk.png, assets/image-20220531165520-92q6hbk.png 1.5x, /2022-02-17-kafka-seek-poll/assets/image-20220531165520-92q6hbk.png 2x"
    data-sizes="auto"
    alt="/2022-02-17-kafka-seek-poll/assets/image-20220531165520-92q6hbk.png"
    title="image.png" /></p>
<p>所以能否拉取到消息，与poll是新版还是旧版无关。</p>
<p>延伸阅读，关于poll方法改版的KIP：</p>
<blockquote>
<p><a
  href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-266%3A&#43;Fix&#43;consumer&#43;indefinite&#43;blocking&#43;behavior"
  
  
    
    
    target="_blank"
  
  
    rel="external nofollow noopener noreffer"
  
  
  
>KIP-266: Fix consumer indefinite blocking behavior</a></p>
<p>关键内容摘抄如下：</p>
<p>Consumer#poll</p>
<p>The pre-existing variant <code>poll(long timeout)</code> would block indefinitely for metadata updates if they were needed, then it would issue a fetch and poll for <code>timeout</code> ms for new records. The initial indefinite metadata block caused applications to become stuck when the brokers became unavailable. The existence of the timeout parameter made the indefinite block especially unintuitive.</p>
<p>We will add a new method <code>poll(Duration timeout)</code> with the semantics:</p>
<ol>
<li>
<p>iff a metadata update is needed:</p>
<ol>
<li>
<p>send (asynchronous) metadata requests</p>
</li>
<li>
<p>poll for metadata responses (counts against timeout)</p>
<ul>
<li>if no response within timeout, return an empty collection immediately</li>
</ul>
</li>
</ol>
</li>
<li>
<p>if there is fetch data available, return it immediately</p>
</li>
<li>
<p>if there is no fetch request in flight, send fetch requests</p>
</li>
<li>
<p>poll for fetch responses (counts against timeout)</p>
<ul>
<li>if no response within timeout, return an empty collection (leaving async fetch request for the next poll)</li>
<li>if we get a response, return the response</li>
</ul>
</li>
</ol>
<p>We will deprecate the original method, <code>poll(long timeout)</code>, and we will not change its semantics, so it remains:</p>
<ol>
<li>
<p>iff a metadata update is needed:</p>
<ol>
<li>send (asynchronous) metadata requests</li>
<li>poll for metadata responses <em>indefinitely until we get it</em></li>
</ol>
</li>
<li>
<p>if there is fetch data available, return it immediately</p>
</li>
<li>
<p>if there is no fetch request in flight, send fetch requests</p>
</li>
<li>
<p>poll for fetch responses (counts against timeout)</p>
<ul>
<li>if no response within timeout, return an empty collection (leaving async fetch request for the next poll)</li>
<li>if we get a response, return the response</li>
</ul>
</li>
</ol>
<p>One notable usage is prohibited by the new <code>poll</code>: previously, you could call <code>poll(0)</code> to block for metadata updates, for example to initialize the client, supposedly without fetching records. Note, though, that this behavior is not according to any contract, and there is no guarantee that <code>poll(0)</code> won&rsquo;t return records the first time it&rsquo;s called. Therefore, it has always been unsafe to ignore the response.</p>
</blockquote>
<p>简言之，<code>poll(long timeout)</code> 是无限期阻塞的，会等待订阅的元数据信息更新完成（这个等待时间不包含在timeout之内），确保能拉到消息。而<code>poll(Duration timeout)</code>不会一直阻塞，经过最多timeout后就会返回，不管拉没拉到消息。</p>
<h3 id="猜测2-timeout决定了一切">猜测2 timeout决定了一切</h3>
<p>在调式过程中，我发现不管用用新版的poll，还是老版本的poll，当timeout太小时，如<strong>10ms</strong>，第一次poll多半拉不到消息；timeout足够大时，比如<strong>2000ms</strong>，每次都拉到消息了。于是我得出结论：将timeout设置足够大即可。不足的是，如果传入的offset参数越界，该位置本来就没有消息，poll方法也会等待timeout才返回（<strong>这里或许是kafka的一个待优化的点？</strong>），浪费时间，于是我决定加一个检查，当传入的offset超过partition的起始偏移量时，快速返回。代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">seekAndPoll</span><span class="o">(</span><span class="n">String</span> <span class="n">topic</span><span class="o">,</span> <span class="kt">int</span> <span class="n">partition</span><span class="o">,</span> <span class="kt">long</span> <span class="n">offset</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TopicPartition</span> <span class="n">tp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopicPartition</span><span class="o">(</span><span class="n">topic</span><span class="o">,</span> <span class="n">partition</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">consumer</span><span class="o">.</span><span class="na">assign</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">tp</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;assignment:&#34;</span> <span class="o">+</span> <span class="n">consumer</span><span class="o">.</span><span class="na">assignment</span><span class="o">());</span> <span class="c1">// 这里是有分配到分区的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// endOffset: the offset of the last successfully replicated message plus one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// if there has 5 messages, valid offsets are [0,1,2,3,4], endOffset is 4+1=5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Long</span> <span class="n">endOffset</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">endOffsets</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">tp</span><span class="o">)).</span><span class="na">get</span><span class="o">(</span><span class="n">tp</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Long</span> <span class="n">beginOffset</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">beginningOffsets</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">tp</span><span class="o">)).</span><span class="na">get</span><span class="o">(</span><span class="n">tp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">beginOffset</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">endOffset</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;offset is illegal&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">consumer</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">tp</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="n">2000</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">records</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">records</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="真相-consumerendoffsets">真相？ consumer.endOffsets()</h3>
<p>我做了一个测试，在2个topic的4个partition上反复执行猜测2的代码，循环10000次，并更改timeout的大小，期望得出timeout值的大小与seekAndPoll失败之间量化关系。结果发现，即使timeout只有10ms，poll也有非常高的成功率；timeout=50ms时，poll成功率就能达到<strong>100%</strong>。而之前要<code>timeout=1000ms ~ 2000ms</code>才能有这么高的成功率。我反复检查，最终发现是这两行代码造成的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Long</span> <span class="n">beginOffset</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">beginningOffsets</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">tp</span><span class="o">)).</span><span class="na">get</span><span class="o">(</span><span class="n">tp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Long</span> <span class="n">endOffset</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">endOffsets</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">tp</span><span class="o">)).</span><span class="na">get</span><span class="o">(</span><span class="n">tp</span><span class="o">);</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>点进<code>endOffsets</code>方法浏览了一下，底下大概做了<code>fetchOffsetsByTimes</code>、<code>awaitMetadataUpdate</code>等事情。但是consumer.endOffsets()方法也不是万无一失的，当timeout=5ms时，poll成功率为97%。</p>
<p>测试代码见文末。</p>
<h2 id="结论">结论</h2>
<p>就按照上述猜测2的代码写，timeout设置为2000ms或者更大。只要seek传入的offset通过了检查，那么该offset上一定有消息，poll时就会立即返回。因此这个timeout即使设置很大也无影响。</p>
<p><code>consumer.beginOffsets()</code>和<code>consumer.endOffsets()</code>一方面起到了检查offset的作用，另一方面起到了降低timeout的作用（虽然这并不是目的）。</p>
<p>注意，在beginOffset和endOffset确定的情况下进行多次seek，不需要每次都调API去查询，而是应该缓存起来多次使用。在这种情况下，能一次poll到消息就靠timeout了，因此，不要把timeout设置得太小，至少100ms。</p>
<h2 id="测试代码">测试代码</h2>
<p><a
  href="https://github.com/whuwangyong/kafka-test/blob/main/kafka-clients/src/main/java/cn/whu/wy/kafka/test/clients/seek/SeekTest.java"
  
  
    
    
    target="_blank"
  
  
    rel="external nofollow noopener noreffer"
  
  
  
>kafka-test/SeekTest.java at main · whuwangyong/kafka-test (github.com)</a></p>
<br />
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2022-06-03&#32;10:34:27>更新于 2022-06-03&nbsp;<a class="git-hash" href="https://github.com/whuwangyong/whuwangyong.github.io.git/commit/bbe1890c62fa17080b1cc91313b32bc715eb1fba" rel="external nofollow noopener noreffer" target="_blank" title="commit by whuwangyong(whuwangyong@gmail.com) bbe1890c62fa17080b1cc91313b32bc715eb1fba: test no cdn">
                  <i class="fa-solid fa-hashtag fa-fw"></i>bbe1890</a></span>
      </div>
      <div class="post-info-license "></div>
    </div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a
  href="/2022-02-17-kafka-seek-poll/index.md"
  
    title="阅读原始文档"
  
  
  
  
    class="link-to-markdown"
  
  
>阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href="/tags/kafka/">kafka</a>,&nbsp;<a href="/tags/kafka-consumer/">kafka consumer</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/2022-05-30-kafka-tx/" class="prev" rel="prev" title="Kafka事务不完全指南"><i class="fa-solid fa-angle-left fa-fw"></i>Kafka事务不完全指南</a>
      <a href="/2022-07-23-use-process-explorer-to-detect-ad-process/" class="next" rel="next" title="Process Explorer检测弹窗广告的利器">Process Explorer检测弹窗广告的利器<i class="fa-solid fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="utterances"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/" rel="external nofollow noopener noreffer">Utterances</a>.
      </noscript></div></article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line custom">      <a href="https://statcounter.com/p12730999/?guest=1" target="_blank">访问统计</a>
      <!-- Default Statcounter code for github.io https://whuwangyong.github.io/ -->
      <script type="text/javascript">
      var sc_project=12730999; 
      var sc_invisible=0; 
      var sc_security="7ad44351"; 
      var scJsHost = "https://";
      document.write("<sc"+"ript type='text/javascript' src='" + scJsHost + "statcounter.com/counter/counter.js'></"+"script>");
      </script>
      <noscript>
        <div class="statcounter">
          <a title="Web Analytics" href="https://statcounter.com/" target="_blank">
            <img class="statcounter" src="https://c.statcounter.com/12730999/0/7ad44351/0/" alt="Web Analytics" 
              referrerPolicy="no-referrer-when-downgrade">
          </a>
        </div>
      </noscript>
      <!-- End of Statcounter Code --></div><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer" title="Hugo 0.101.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/Lruihao/FixIt" target="_blank" rel="external nofollow noopener noreffer" title="FixIt v0.2.15-RC"><img class="fixit-icon" src="/images/fixit.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
            <span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">
              <a
  href="https://github.com/whuwangyong"
  
  
    
    
    target="_blank"
  
  
    rel="external nofollow noopener noreffer"
  
  
  
>Wang Yong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div></div>
  </footer></div><div class="widgets">
  <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
      <i class="fa-solid fa-arrow-up fa-fw"></i>
    </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
      <i class="fa-solid fa-comment fa-fw"></i>
    </a>
  </div><div id="mask"></div>
</div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js" defer></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js" async defer></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js" defer></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js" defer></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js" defer></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":30},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"title","label":"comments","lightTheme":"github-light","repo":"whuwangyong/whuwangyong.github.io"}},"enablePWA":null,"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"YMLBEBNFHL","algoliaIndex":"new-index-1649076215","algoliaSearchKey":"9028b251fe4eecb5ad4d47af0715a4f0","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js" defer></script></body>
</html>
