<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Kafka事务不完全指南 - 武大路飞</title><meta name="author" content="Wang Yong">
<meta name="author-link" content="https://github.com/whuwangyong">
<meta name="description" content="Kafka的事务是什么 生产者往多个topic里面写消息，要么同时成功，要么同时失败。 为什么需要事务 消息系统有3种语义： 最多一次 最少一次 精确一次。Exactly Only Once 为了实现精确一次的语义，Kafka必须引入事务。如下图： 本应用从上游topic" /><meta name="keywords" content='kafka, kafka事务' /><meta itemprop="name" content="Kafka事务不完全指南">
<meta itemprop="description" content="Kafka的事务是什么 生产者往多个topic里面写消息，要么同时成功，要么同时失败。 为什么需要事务 消息系统有3种语义： 最多一次 最少一次 精确一次。Exactly Only Once 为了实现精确一次的语义，Kafka必须引入事务。如下图： 本应用从上游topic"><meta itemprop="datePublished" content="2022-05-30T00:00:00+08:00" />
<meta itemprop="dateModified" content="2022-06-30T16:09:10+08:00" />
<meta itemprop="wordCount" content="2290"><meta itemprop="image" content="https://whuwangyong.github.io/avatar150x150.jpg"/>
<meta itemprop="keywords" content="kafka,kafka事务," /><meta property="og:title" content="Kafka事务不完全指南" />
<meta property="og:description" content="Kafka的事务是什么 生产者往多个topic里面写消息，要么同时成功，要么同时失败。 为什么需要事务 消息系统有3种语义： 最多一次 最少一次 精确一次。Exactly Only Once 为了实现精确一次的语义，Kafka必须引入事务。如下图： 本应用从上游topic" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://whuwangyong.github.io/2022-05-30-kafka-tx/" /><meta property="og:image" content="https://whuwangyong.github.io/avatar150x150.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-30T00:00:00+08:00" />
<meta property="article:modified_time" content="2022-06-30T16:09:10+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://whuwangyong.github.io/avatar150x150.jpg"/>

<meta name="twitter:title" content="Kafka事务不完全指南"/>
<meta name="twitter:description" content="Kafka的事务是什么 生产者往多个topic里面写消息，要么同时成功，要么同时失败。 为什么需要事务 消息系统有3种语义： 最多一次 最少一次 精确一次。Exactly Only Once 为了实现精确一次的语义，Kafka必须引入事务。如下图： 本应用从上游topic"/>
<meta name="application-name" content="武大路飞">
<meta name="apple-mobile-web-app-title" content="武大路飞"><meta name="theme-color" data-light="map[dark:#252627 iconcolor:#5bbad5 light:#ffffff tilecolor:#da532c]" data-dark="map[dark:#252627 iconcolor:#5bbad5 light:#ffffff tilecolor:#da532c]" content="map[dark:#252627 iconcolor:#5bbad5 light:#ffffff tilecolor:#da532c]"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://whuwangyong.github.io/2022-05-30-kafka-tx/" /><link rel="prev" href="https://whuwangyong.github.io/2022-05-20-why-kafka-offset-not-sequential/" /><link rel="next" href="https://whuwangyong.github.io/2022-02-17-kafka-seek-poll/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Kafka事务不完全指南",
    "inLanguage": "",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/whuwangyong.github.io\/2022-05-30-kafka-tx\/"
    },"image": ["https:\/\/whuwangyong.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "kafka, kafka事务","wordcount":  2290 ,
    "url": "https:\/\/whuwangyong.github.io\/2022-05-30-kafka-tx\/","datePublished": "2022-05-30T00:00:00+08:00","dateModified": "2022-06-30T16:09:10+08:00","publisher": {
      "@type": "Organization",
      "name": "Wang Yong","logo": {
          "@type": "ImageObject",
          "url": "https:\/\/whuwangyong.github.io\/images\/avatar150x150.jpg",
          "width":  150 ,
          "height":  151 
        }},"author": {
        "@type": "Person",
        "name": "Wang Yong"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="武大路飞"><span class="header-title-pre"><i class='fa fa-home'></i></span><span class="header-title-text">武大路飞的博客</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >归档</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/links/"
                title="友情链接"
                
              >友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="https://github.com/whuwangyong"
                title="GitHub"
                rel="noopener noreferrer" target="_blank"
              ><i class='fab fa-github fa-fw'></i> GitHub</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="武大路飞"><span class="header-title-pre"><i class='fa fa-home'></i></span><span class="header-title-text">武大路飞的博客</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >归档</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/links/"
                  title="友情链接"
                  
                >友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="https://github.com/whuwangyong"
                  title="GitHub"
                  rel="noopener noreferrer" target="_blank"
                ><i class='fab fa-github fa-fw'></i> GitHub</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="custom"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>Kafka事务不完全指南</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/whuwangyong" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/images/avatar150x150.jpg"
    data-srcset="/images/avatar150x150.jpg, /images/avatar150x150.jpg 1.5x, /images/avatar150x150.jpg 2x"
    data-sizes="auto"
    alt="Wang Yong"
    title="Wang Yong" width="150" height="151"/>&nbsp;Wang Yong</a></span>
          <span class="post-category">收录于 <a href="/categories/kafka/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> kafka</a></span></div>
      <div class="post-meta-line"><span title=2022-05-30&#32;00:00:00><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-05-30">2022-05-30</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 2290 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 5 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#kafka的事务是什么">Kafka的事务是什么</a></li>
        <li><a href="#为什么需要事务">为什么需要事务</a></li>
        <li><a href="#zombie-instances">Zombie instances</a></li>
        <li><a href="#zombie-fencing">Zombie fencing</a></li>
        <li><a href="#代码">代码</a></li>
        <li><a href="#how-transactions-work">How Transactions Work</a></li>
        <li><a href="#the-transaction-coordinator-and-transaction-log">The Transaction Coordinator and Transaction Log</a></li>
        <li><a href="#data-flow">Data flow</a></li>
        <li><a href="#how-to-pick-a-transactionalid">How to pick a transactional.id</a></li>
        <li><a href="#how-transactions-perform-and-how-to-tune-them">How transactions perform, and how to tune them</a></li>
        <li><a href="#幂等producer与事务producer">幂等producer与事务producer</a></li>
        <li><a href="#事务型消费者可以消费未启用事务的普通消息吗">事务型消费者，可以消费未启用事务的普通消息吗</a></li>
        <li><a href="#如何实现跨数据源的事务kafkadb混合事务">如何实现跨数据源的事务：kafka+DB混合事务</a></li>
        <li><a href="#reference">Reference</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h3 id="kafka的事务是什么">Kafka的事务是什么</h3>
<p>生产者往多个topic里面写消息，要么同时成功，要么同时失败。</p>
<h3 id="为什么需要事务">为什么需要事务</h3>
<p>消息系统有3种语义：</p>
<ol>
<li>最多一次</li>
<li>最少一次</li>
<li>精确一次。Exactly Only Once</li>
</ol>
<p>为了实现精确一次的语义，Kafka必须引入事务。如下图：</p>
<p>本应用从上游topic消费消息，处理后发到下游topic，同时将处理进度发送到<code>__consumer_offsets</code>topic里面进行保存，对这两个topic的写，是一个原子操作（atomic）。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/2022-05-30-kafka-tx/assets/image-20220530095714242.png"
    data-srcset="/2022-05-30-kafka-tx/assets/image-20220530095714242.png, /2022-05-30-kafka-tx/assets/image-20220530095714242.png 1.5x, /2022-05-30-kafka-tx/assets/image-20220530095714242.png 2x"
    data-sizes="auto"
    alt="image-20220530095714242"
    title="image-20220530095714242" width="415" height="151"/></p>
<p>如果没有事务，发生以下情况时，消息可能会重复或者丢失：</p>
<blockquote>
<ul>
<li>A broker can fail</li>
<li>The producer-to-broker RPC can fail</li>
<li>The client can fail</li>
</ul>
</blockquote>
<h3 id="zombie-instances">Zombie instances</h3>
<p>在分布式系统中，主节点由于网络闪断等原因，被一致性协议踢出，过了一会儿又恢复过来，并希望与现任主节点做同样的事情。前任主节点就是zombie instances。</p>
<h3 id="zombie-fencing">Zombie fencing</h3>
<blockquote>
<p>We solve the problem of zombie instances by requiring that each transactional producer be assigned a unique identifier called the  <em>transactional.id</em> . This is used to identify the same producer instance across process restarts.</p>
</blockquote>
<p><em>transactional.id</em> 能够跨越进程重启。也就是说，当主节点宕机后，备节点使用主节点的<em>transactional.id</em> 继续干活，是可以的。也就说，事务id “is consistent across producer sessions”。</p>
<h3 id="代码">代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//Read and validate deposits validated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Deposits</span> <span class="o">=</span> <span class="n">validate</span><span class="o">(</span><span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">0</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Send validated deposits &amp; commit offsets atomically
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">producer</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">()</span> 
</span></span><span class="line"><span class="cl"><span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">validatedDeposits</span><span class="o">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">producer</span><span class="o">.</span><span class="na">sendOffsetsToTransaction</span><span class="o">(</span><span class="n">offsets</span><span class="o">(</span><span class="n">consumer</span><span class="o">))</span> 
</span></span><span class="line"><span class="cl"><span class="n">producer</span><span class="o">.</span><span class="na">endTransaction</span><span class="o">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="how-transactions-work">How Transactions Work</h3>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/2022-05-30-kafka-tx/assets/image-20220528201239-6jlhsxf.jpg"
    data-srcset="/2022-05-30-kafka-tx/assets/image-20220528201239-6jlhsxf.jpg, /2022-05-30-kafka-tx/assets/image-20220528201239-6jlhsxf.jpg 1.5x, /2022-05-30-kafka-tx/assets/image-20220528201239-6jlhsxf.jpg 2x"
    data-sizes="auto"
    alt="image.png"
    title="image.png" width="461" height="312"/></p>
<h3 id="the-transaction-coordinator-and-transaction-log">The Transaction Coordinator and Transaction Log</h3>
<blockquote>
<p>The transaction coordinator is a module running <strong>inside every Kafka broker</strong>. The transaction log is an <strong>internal kafka topic</strong>. Each coordinator owns some subset of the partitions in the transaction log, ie. the partitions for <strong>which its broker is the leader</strong>.</p>
<p>Every transactional.id is mapped to a specific partition of the transaction log through a simple hashing function. This means that exactly one coordinator owns a given transactional.id.</p>
</blockquote>
<p>每个broker里面都有一个事务协调者。transaction log是一个内部topic。</p>
<h3 id="data-flow">Data flow</h3>
<p>4个阶段</p>
<ol>
<li>
<p>生产者与协调者的交互</p>
<ol>
<li>生产者使用initTransactions API向协调者注册一个事务id。此时，协调者会close所有具有相同事务id且处于pending状态的事务，并把其epoch 纳入 fence out zombies</li>
<li>生产者在一个事务里第一次对一个分区发消息时，该分区会在协调者注册</li>
<li>应用调用commit或abort方法时，客户端会发一个请求到协调者，协调者开始做二阶段提交</li>
</ol>
</li>
<li>
<p>协调者与transaction log的交互</p>
<p>协调者是唯一一个读写transaction log的组件。</p>
</li>
<li>
<p>生产者写数据到目标分区</p>
</li>
<li>
<p>协调者与目标分区的交互</p>
<p>生产者commit或abort时，协调者开始执行2PC：</p>
<ol>
<li>在内存更新事务状态为“prepare_commit”，也更新transaction log里的状态</li>
<li>将 <strong>commit markers</strong> 写到本事务涉及到的topic-partitions</li>
<li>更新事务状态为“complete”</li>
</ol>
</li>
</ol>
<h3 id="how-to-pick-a-transactionalid">How to pick a transactional.id</h3>
<blockquote>
<p>The transactional.id plays a major role in fencing out zombies. But maintaining an identifier that is consistent across producer sessions and also fences out zombies properly is a bit tricky.</p>
<p>The key to fencing out zombies properly is to ensure that the input topics and partitions in the read-process-write cycle is always the same for a given transactional.id. If this isn’t true, then it is possible for some messages to leak through the fencing provided by transactions.</p>
<p>For instance, in a distributed stream processing application, suppose topic-partition <em>tp0</em> was originally processed by transactional.id *T0. *If, at some point later, it could be mapped to another producer with transactional.id *T1, *there would be no fencing between <em>T0</em> and *T1. *So it is possible for messages from <em>tp0</em> to be reprocessed, violating the exactly-once processing guarantee.</p>
<p>Practically, one would either have to store the mapping between input partitions and transactional.ids in an external store, or have some static encoding of it. Kafka Streams opts for the latter approach to solve this problem.</p>
</blockquote>
<h3 id="how-transactions-perform-and-how-to-tune-them">How transactions perform, and how to tune them</h3>
<p>Performance of the transactional producer 事务的性能开销</p>
<p>Transactions cause only moderate write amplification（有限的写放大）. The additional writes are due to:</p>
<ol>
<li>additional RPCs to register the partitions with the coordinator</li>
<li>transaction marker has to be written to each partition</li>
<li>write state changes to the transaction log</li>
</ol>
<p>事务提交的批次越小、间隔越小，性能损耗越大。对于1KB消息，每100ms提交一次，吞吐下降3%。但是，批次（间隔）越大，消息的实时性越差。</p>
<p>事务对消费者来说几乎没性能损失。</p>
<h3 id="幂等producer与事务producer">幂等producer与事务producer</h3>
<ul>
<li>幂等producer，其id是没持久化的。重启后会变。</li>
<li>事务producer，其id是事务id。这个id在producer重启后也不会变。</li>
<li>虽然producer重启后事务id不会变，但是，一个新的producer session创建时，会再次执行initTransactions()，epoch会增加。假设旧的producer并没彻底宕机，当它恢复过来时，尝试使用旧的epoch提交事务，就会报错。</li>
</ul>
<h3 id="事务型消费者可以消费未启用事务的普通消息吗">事务型消费者，可以消费未启用事务的普通消息吗</h3>
<p>可以。</p>
<blockquote>
<p>官方文档对<strong>isolation.level</strong>的描述：</p>
<p>If set to  <code>read_committed</code> , consumer.poll() will only return transactional messages which have been committed. If set to  <code>read_uncommitted</code>(the default), consumer.poll() will return all messages, even transactional messages which have been aborted. <strong>Non-transactional messages will be returned unconditionally in either mode</strong>.</p>
<p>最后一句：不管在哪种模式下，非事务的消息都是无条件返回。</p>
</blockquote>
<h3 id="如何实现跨数据源的事务kafkadb混合事务">如何实现跨数据源的事务：kafka+DB混合事务</h3>
<p>对于如下的一个逻辑：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/2022-05-30-kafka-tx/assets/image-20220530104540910.png"
    data-srcset="/2022-05-30-kafka-tx/assets/image-20220530104540910.png, /2022-05-30-kafka-tx/assets/image-20220530104540910.png 1.5x, /2022-05-30-kafka-tx/assets/image-20220530104540910.png 2x"
    data-sizes="auto"
    alt="image-20220530104540910"
    title="image-20220530104540910" width="314" height="257"/></p>
<p>本应用消费上游topic的消息，然后将结果1发送到下游topic，同时将结果2写入db，另外还要提交消费进度到<code>__consumer_offsets</code>topic。如何保证这3个写操作是一个事务？kafka的事务并不支持跨数据源。官方文档如下：</p>
<blockquote>
<p>When writing to an external system, the limitation is in the need to coordinate the consumer&rsquo;s position with what is actually stored as output. The classic way of achieving this would be to introduce a two-phase commit between the storage of the consumer position and the storage of the consumers output. But this can be handled more simply and generally by letting the consumer store its offset in the same place as its output.</p>
<p>—— <a href="https://kafka.apache.org/documentation/#semantics"target="_blank" rel="external nofollow noopener noreferrer">Apache Kafka Documentation - 4.6 Message Delivery Semantics</a></p>
<p>The main restriction with Transactions is they only work in situations where both the input comes from Kafka and the output is written to a Kafka topic. If you are calling an external service (e.g., via HTTP), updating a database, writing to stdout, or anything other than writing to and from the Kafka broker, transactional guarantees won’t apply and calls can be duplicated. This is exactly how a transactional database works: the transaction works only within the confines of the database, but because Kafka is often used to link systems it can be a cause of confusion. Put another way, Kafka’s transactions are not inter-system transactions such as those provided by technologies that implement <a href="https://en.wikipedia.org/wiki/X/Open_XA" title="X/Open XA"target="_blank" rel="external nofollow noopener noreferrer">XA</a>.</p>
<p>—— <a href="https://developer.confluent.io/learn/kafka-transactions-and-guarantees/#what-cant-transactions-do"target="_blank" rel="external nofollow noopener noreferrer">What Can&rsquo;t Transactions Do?</a></p>
</blockquote>
<p>官方建议，“letting the consumer store its offset in the same place as its output”，将输出保存到同一数据源：要么全部写数据库（消费进度也存在数据库里），此时可以用数据库的事务；要么全部写kafka。</p>
<p>根据这种思路，提供设计如下：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/2022-05-30-kafka-tx/assets/image-20220530104521400.png"
    data-srcset="/2022-05-30-kafka-tx/assets/image-20220530104521400.png, /2022-05-30-kafka-tx/assets/image-20220530104521400.png 1.5x, /2022-05-30-kafka-tx/assets/image-20220530104521400.png 2x"
    data-sizes="auto"
    alt="image-20220530104521400"
    title="image-20220530104521400" width="686" height="383"/></p>
<p>结果2也写到kafka里面，这样写结果1+结果2+消费进度是一个kafka事务，可以做到精确一次消费。然后单独写一个持久化线程，将数据从kafka里面消费，写到db。<strong>注意写db的时候，需要将消费进度一起写入db，利用数据库事务来确保精确一次持久化。</strong></p>
<h3 id="reference">Reference</h3>
<ol>
<li><a href="https://www.baeldung.com/kafka-exactly-once"target="_blank" rel="external nofollow noopener noreferrer">Exactly Once Processing in Kafka with Java | Baeldung</a></li>
<li><a href="https://resources.confluent.io/all-content/kafka-the-definitive-guide-v2"target="_blank" rel="external nofollow noopener noreferrer">Kafka: The Definitive Guide(2nd Edition)</a></li>
<li><a href="https://kafka.apache.org/documentation/"target="_blank" rel="external nofollow noopener noreferrer">Apache Kafka Documentation</a></li>
<li><a href="https://www.confluent.io/blog/transactions-apache-kafka/"target="_blank" rel="external nofollow noopener noreferrer">Transactions in Apache Kafka | Confluent</a></li>
<li><a href="https://developer.confluent.io/learn/kafka-transactions-and-guarantees/"target="_blank" rel="external nofollow noopener noreferrer">Building Systems Using Transactions in Apache Kafka® (confluent.io)</a></li>
<li><a href="https://www.confluent.io/blog/exactly-once-semantics-are-possible-heres-how-apache-kafka-does-it/"target="_blank" rel="external nofollow noopener noreferrer">Exactly-once Semantics is Possible: Here&rsquo;s How Apache Kafka Does it (confluent.io)</a></li>
</ol>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2022-06-30&#32;16:09:10>更新于 2022-06-30&nbsp;<a class="git-hash" href="https://github.com/whuwangyong/whuwangyong.github.io.git/commit/e2bf8a0f5531601234357c9458e305c8723ca264" rel="external nofollow noopener noreferrer" target="_blank" title="commit by whuwangyong(whuwangyong@gmail.com) e2bf8a0f5531601234357c9458e305c8723ca264: update post: kafka-tx"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i>e2bf8a0</a></span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/2022-05-30-kafka-tx/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/kafka/">kafka</a>,&nbsp;<a href="/tags/kafka%E4%BA%8B%E5%8A%A1/">kafka事务</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/2022-05-20-why-kafka-offset-not-sequential/" class="post-nav-item" rel="prev" title="kafka offset为什么不连续"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>kafka offset为什么不连续</a>
      <a href="/2022-02-17-kafka-seek-poll/" class="post-nav-item" rel="next" title="kafka consumer seek之后立即poll可能拉不到消息">kafka consumer seek之后立即poll可能拉不到消息<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/" rel="external nofollow noopener noreferrer">Utterances</a>.
      </noscript></div></article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line custom">      <a href="https://statcounter.com/p12730999/?guest=1" target="_blank">访问统计</a>
      <!-- Default Statcounter code for github.io https://whuwangyong.github.io/ -->
      <script type="text/javascript">
      var sc_project=12730999; 
      var sc_invisible=0; 
      var sc_security="7ad44351"; 
      var scJsHost = "https://";
      document.write("<sc"+"ript type='text/javascript' src='" + scJsHost + "statcounter.com/counter/counter.js'></"+"script>");
      </script>
      <noscript>
        <div class="statcounter">
          <a title="Web Analytics" href="https://statcounter.com/" target="_blank">
            <img class="statcounter" src="https://c.statcounter.com/12730999/0/7ad44351/0/" alt="Web Analytics" 
              referrerPolicy="no-referrer-when-downgrade">
          </a>
        </div>
      </noscript>
      <!-- End of Statcounter Code --></div><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.101.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.17-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/whuwangyong"target="_blank" rel="external nofollow noopener noreferrer">Wang Yong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":30},"comment":{"enable":true,"expired":false,"utterances":{"darkTheme":"github-dark","issueTerm":"title","label":"comments","lightTheme":"github-light","repo":"whuwangyong/whuwangyong.github.io"}},"lightgallery":true,"search":{"algoliaAppID":"YMLBEBNFHL","algoliaIndex":"new-index-1649076215","algoliaSearchKey":"9028b251fe4eecb5ad4d47af0715a4f0","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
